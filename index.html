<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2025生日应援之我与GD的特别印记</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--accent:#ff3b30}


  :root {
  --bg: #e0f1ff;
  /* --card: #daf5ff; */
  --card: #feeffd;
  --accent: #42b6f9; /* #ffd2fe */
  }
  body {
    color: #012854;
  }

  body{font-family: Arial,"Helvetica Neue",Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh}
  .wrap{width:980px;max-width:95%;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}

/*   .wrap {
  border: 3px solid transparent;
  border-image: linear-gradient(45deg, #fdc9ff, #94d0f8) 1;
  } */

/*   body {
    background: url('images/bg3.jpg') no-repeat center center fixed;
    background-size: cover;
  } */

  .falling {
    color: pink; /* 自定义下落颜色 */
  }
  #orderId {
    width: 300px;
  }
  #nickname {
    width: 300px;
  }

  h1{margin:0 0 10px;font-size:20px}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
  input[type="text"], input[type="file"]{padding:8px 10px;font-size:15px;border:1px solid #dddddd;border-radius:6px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #canvas{border:1px solid #e2e2e2;margin-top:14px;max-width:100%}
  @font-face{
    font-family:'MyFontCN';
    src: url('fonts/MyFontCN4.ttf') format('truetype');
  }
  @font-face{
    font-family:'MyFontEN';
    src: url('fonts/MyFontEN2.ttf') format('truetype');
  }
</style>
</head>
<body>

<img src="images/banner.png" alt="banner" style="max-width:20%; border-radius:12px; margin-bottom:20px;">



<div class="wrap">
    <h1>♥我与G-Dragon的特别印记♥</h1>
    <p class="note">步骤：输入订单号查询专属生日应援编号 → 查询成功后输入昵称 → 实时预览 → 下载PNG。</p>

    <div id="step1">
      <p><strong>1. 查询我的GD生日应援编号：</strong></p>
      <div class="row">
        <input id="orderId" type="text" placeholder="输入礼包的订单号哟ξ( ✿＞◡❛)" />
        <button id="checkBtn">查询我的编号</button>
      </div>
      <p class="small">注：订单号来自2025双城应援礼包购买记录。</p>
    </div>

    <div id="step2" style="display:none;margin-top:10px;">
      <p><strong>2. 输入昵称：</strong></p>
      <div class="row">
        <input id="nickname" type="text" placeholder="12字符以内的中英文或数字✧*｡٩(ˊᗜˋ*)و✧*｡" maxlength="12" />
        <button id="genBtn">生成并显示预览</button>
        <button id="downloadBtn" style="display:none;background:#333">下载PNG</button>
      </div>
<!--       <div class="row">
        <label>上传贴纸（可选）：</label>
        <input type="file" id="uploadSticker" accept="image/png, image/jpeg">
      </div> -->
      <p class="small">如果想在输入过程中实时看到效果，请直接在输入框输入，预览会自动更新。</p>
    </div>



    <div id="previewBox">
      <div class="left">
        <canvas id="canvas" width="1080" height="1080" style="display:none"></canvas>
      </div>
      <div class="right">
        <div id="info" style="font-size:14px;color:#444">
          <p>我的编号：<span id="currentNumber">—</span></p>
          <p>文件下载示例：<span id="filenameExample">—</span></p>
          <!-- <p class="small">调整：要改变序号/昵称在图上的位置或样式，请编辑 <code>index.html</code> 内的 <code>numberPos</code>、<code>namePos</code> 和字体设置。</p> -->
        </div>
      </div>
    </div>

</div>

<canvas id="canvas" style="max-width: 800px; height: auto;"></canvas>

<script>
(async ()=> {
  // ---------- 配置 ----------
/*   const canvasSize = { w:5906, h:7087 };
  const numberPos = { x: 3800, y: 5900, font: '450px MyFontEN', color: '#FFFFFF' };
  //const namePos   = { x: 1790, y: 4700, font: ' 300px MyFontCN', color: '#FFFFFF' };
  const namePos   = { x: 1990, y: 5150, font: ' 300px MyFontCN', color: '#FFFFFF' };
/*   const numberPos = { x: 200, y: 5240, font: '450px MyFontEN', color: '#FFFFFF' };
  const namePos   = { x: 4590, y: 5600, font: ' 300px MyFontCN', color: '#FFFFFF' }; 1920 5200*/ 

  const canvasSize = { w: 2000, h: 2400 };  // 缩小版
  const numberPos = { x: 1280, y: 2000, font: '150px MyFontEN', color: '#FFFFFF' };
  const namePos   = { x: 670,  y: 1745, font: '100px MyFontCN', color: '#FFFFFF' };


  const allowedNameRegex = /^[\u4e00-\u9fa5A-Za-z0-9]+$/;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // ---------- 贴纸相关 ----------
  let stickerImg = null;
  let stickerX = 350, stickerY = 50, stickerW = 200, stickerH = 200;
  const resizeHandleSize = 100;
  let dragging = false, resizing = false;
  let dragOffsetX = 0, dragOffsetY = 0;

  // 载入订单表
  let orders = null;
  async function loadOrders() {
    try {
      const resp = await fetch('data/orders.json', {cache: "no-store"});
      if (!resp.ok) throw new Error('fetch fail');
      orders = await resp.json();
    } catch (e) {
      alert('加载订单数据失败，请用本地服务器运行');
      console.error(e);
    }
  }
  await loadOrders();

  async function waitFonts() {
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch(e){}
    } else {
      await new Promise(r=>setTimeout(r,300));
    }
  }

  // 绘制头像
  async function draw(number, name) {
    if (!orders) return;
    await waitFonts();
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = () => {
        canvas.width = canvasSize.w;
        canvas.height = canvasSize.h;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        // 序号
        ctx.fillStyle = numberPos.color;
        ctx.textAlign = 'left';
        ctx.font = numberPos.font;
        ctx.fillText(`No.${number}`, numberPos.x, numberPos.y);
        // 昵称
        ctx.fillStyle = namePos.color;
        let nickname = document.getElementById('nickname').value;
/*         if (/^[\u4e00-\u9fa5]+$/.test(nickname)) {
          ctx.font = '240px MyFontCN';
        } else {
          ctx.font = '220px MyFontCN';
        }  */

        if (/^[\u4e00-\u9fa5]+$/.test(nickname)) {
          ctx.font = '80px MyFontCN';
        } else {
          ctx.font = '73px MyFontCN';
        } 
        ctx.textAlign = 'right';
        //ctx.font = '240px MyFontCN';
        ctx.fillText(`「${name}」`, namePos.x, namePos.y);
        //ctx.fillText(`${name}`, namePos.x, namePos.y);
        // 绘制贴纸
        if (stickerImg) {
          ctx.drawImage(stickerImg, stickerX, stickerY, stickerW, stickerH);
          // 绘制缩放手柄
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(stickerX + stickerW - resizeHandleSize/2,
                       stickerY + stickerH - resizeHandleSize/2,
                       resizeHandleSize, resizeHandleSize);
        }
        canvas.style.display = 'block';
        resolve();
      };
      img.onerror = reject;
      img.src = 'images/template7.png';
    });
  }

  // 元素
  const orderInput = document.getElementById('orderId');
  const checkBtn = document.getElementById('checkBtn');
  const step2 = document.getElementById('step2');
  const nicknameInput = document.getElementById('nickname');
  const genBtn = document.getElementById('genBtn');
  const downBtn = document.getElementById('downloadBtn');
  const currentNumberSpan = document.getElementById('currentNumber');
  const filenameExample = document.getElementById('filenameExample');
  const uploadSticker = document.getElementById('uploadSticker');

  let currentNumber = null;

  checkBtn.addEventListener('click', ()=>{
    const id = (orderInput.value||'').trim();
    if (!id) { alert('请输入订单号'); return; }
    if (!orders) { alert('订单数据未加载'); return; }
    if (!orders[id]) { alert('未找到该订单号'); return; }
    currentNumber = orders[id];
    currentNumberSpan.textContent = currentNumber;
    filenameExample.textContent = `No_${currentNumber}_你的昵称.png`;
    step2.style.display = 'block';
    nicknameInput.focus();
    draw(currentNumber, nicknameInput.value || '昵称');
  });

  nicknameInput.addEventListener('input', async ()=>{
    const name = nicknameInput.value.trim();
    if (!currentNumber) return;
    await draw(currentNumber, name || '昵称');
  });

  genBtn.addEventListener('click', async ()=>{
    const name = nicknameInput.value.trim();
    if (!currentNumber) { alert('请先校验订单号'); return; }
    if (!name) { alert('请输入昵称'); return; }
    if (!allowedNameRegex.test(name)) { alert('昵称只能含中/英/数字'); return; }
    await draw(currentNumber, name);
    downBtn.style.display = 'inline-block';
    filenameExample.textContent = `No_${currentNumber}_${name}.png`;
  });

  downBtn.addEventListener('click', ()=>{
    const name = nicknameInput.value.trim() || '昵称';
    const link = document.createElement('a');
    const safeName = name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,'_');
    link.download = `No_${currentNumber}_${safeName}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  // 上传贴纸
  uploadSticker.addEventListener('change', e=>{
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev=>{
        stickerImg = new Image();
        stickerImg.onload = ()=> draw(currentNumber, nicknameInput.value || '昵称');
        stickerImg.src = ev.target.result;
        // 初始位置大小
        stickerX = 500; stickerY = 500; stickerW = 600; stickerH = 600;
      };
      reader.readAsDataURL(file);
    }
  });

  // 贴纸拖拽缩放事件
  function isOnSticker(mx, my) {
    return mx >= stickerX && mx <= stickerX+stickerW && my >= stickerY && my <= stickerY+stickerH;
  }
  function isOnResizeHandle(mx,my) {
    return mx >= stickerX+stickerW-resizeHandleSize &&
           mx <= stickerX+stickerW+resizeHandleSize &&
           my >= stickerY+stickerH-resizeHandleSize &&
           my <= stickerY+stickerH+resizeHandleSize;
  }
  canvas.addEventListener('mousedown', e=>{
    if (!stickerImg) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    if (isOnResizeHandle(mx,my)) {
      resizing = true;
    } else if (isOnSticker(mx,my)) {
      dragging = true;
      dragOffsetX = mx - stickerX;
      dragOffsetY = my - stickerY;
    }
  });
  canvas.addEventListener('mousemove', e=>{
    if (!stickerImg) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    if (dragging) {
      stickerX = mx - dragOffsetX;
      stickerY = my - dragOffsetY;
      draw(currentNumber, nicknameInput.value || '昵称');
    } else if (resizing) {
      stickerW = Math.max(20, mx - stickerX);
      stickerH = Math.max(20, my - stickerY);
      draw(currentNumber, nicknameInput.value || '昵称');
    }
  });
  canvas.addEventListener('mouseup', ()=>{
    dragging = false;
    resizing = false;
  });
  canvas.addEventListener('mouseleave', ()=>{
    dragging = false;
    resizing = false;
  });

})();
</script>
<!-- 
<style>
  .falling {
    position: fixed;
    top: -50px;
    pointer-events: none;
    will-change: transform;
    user-select: none;
  }
</style>

<script>
  function createFallingEmoji() {
    const emoji = ["🌸","❀","✿","❤","💕","🌹","💗","💝","🌼","🎉","🎊","🎈","🎁","🎀","🎂","🍰","🌟","⭐","💫"]; 
    const images = ["images/fall.png", "images/fall.png", "images/fall2.png", "images/fall3.png", "images/fall4.png", "images/fall5.png", "images/fall6.png", "images/fall7.png"];

    const el = document.createElement("div");
    el.className = "falling";

    // 随机选择emoji或图片
    if (Math.random() < 0.3) {
      const img = document.createElement("img");
      img.src = images[Math.floor(Math.random() * images.length)];
      img.style.width = (20 + Math.random() * 30) + "px";
      el.appendChild(img);
    } else {
      el.innerText = emoji[Math.floor(Math.random() * emoji.length)];
      el.style.fontSize = (10 + Math.random() * 20) + "px";
    }

    // 初始位置
    el.style.left = Math.random() * window.innerWidth + "px";
    el.style.top = "-50px";
    document.body.appendChild(el);

    // 模拟自由落体
    let pos = -50;
    const ground = window.innerHeight - 50 - Math.random() * 30; // 随机高度，避免全都一排
    const speed = 2 + Math.random() * 3; // 下落速度
    const timer = setInterval(() => {
      pos += speed;
      if (pos >= ground) {
        pos = ground;
        el.style.top = pos + "px";
        clearInterval(timer);

        // 停留一会儿再消失
        setTimeout(() => {
          el.style.transition = "opacity 1s";
          el.style.opacity = 0;
          setTimeout(() => el.remove(), 1000);
        }, 4000); // 4秒后消失
      } else {
        el.style.top = pos + "px";
      }
    }, 20);
  }

  // 每隔300ms生成一个
  setInterval(createFallingEmoji, 300);
</script> -->


<style>
  .falling {
    position: fixed;
    top: -50px;
    animation: fall linear forwards;
    pointer-events: none;
  }

  @keyframes fall {
    to {
      transform: translateY(110vh) rotate(360deg);
      opacity: 0.8;
    }
  }
</style>

<script>
  function createFallingEmoji() {
    const emoji = ["🌸","❀","✿","❤","💕","🌹","💗","💝","🌼","🎉","🎊","🎈","🎁","🎀","🎂","🍰","🌟","⭐","💫"]; 
    const images = ["images/fall.png", "images/fall.png", "images/fall.png", "images/fall.png", "images/fall2.png", "images/fall3.png", "images/fall4.png", "images/fall5.png", "images/fall6.png", "images/fall7.png"]; // 你的 PNG 路径，可以放多个

    const el = document.createElement("div");
    el.className = "falling";

    if (Math.random() < 0.5) {
      // 30% 概率用 PNG
      const img = document.createElement("img");
      img.src = images[Math.floor(Math.random() * images.length)];
      img.style.width = (20 + Math.random() * 30) + "px"; // 随机大小
      el.appendChild(img);
    } else {
      // 70% 概率用 emoji
      el.innerText = emoji[Math.floor(Math.random() * emoji.length)];
      el.style.fontSize = (10 + Math.random() * 20) + "px";
    }

    // 随机位置 & 动画时长
    el.style.left = Math.random() * window.innerWidth + "px";
    el.style.animationDuration = (6 + Math.random() * 5) + "s";

    document.body.appendChild(el);

    // 动画结束后清理元素
    setTimeout(() => el.remove(), 10000);
  }

  // 每隔300ms生成一个
  setInterval(createFallingEmoji, 100);
</script> 


<!-- <style>
  .falling {
    position: fixed;
    top: -50px;
    font-size: 24px;
    animation: fall linear forwards;
    pointer-events: none;
  }

  @keyframes fall {
    to {
      transform: translateY(110vh) rotate(360deg);
      opacity: 0.8;
    }
  }
</style>

<script>
  function createFallingEmoji() {
    const emoji = ["🌸","❀","✿","❤","💕","🌹","💗","💝","🌼","🎉","🎊","🎈","🎁","🎀","🎂","🍰","🌟","⭐","💫"]; 
    //  "❤","★","✨" ,"🎉","🎊","🎈","🎁","🎀","🎂","🧁","🍩","🍮","🍰","🌟","⭐","💫",""
    // 
    const el = document.createElement("div");
    el.className = "falling";
    el.innerText = emoji[Math.floor(Math.random() * emoji.length)];
    
    // 随机位置/大小/动画时长
    el.style.left = Math.random() * window.innerWidth + "px";
    el.style.fontSize = (10 + Math.random() * 20) + "px";
    el.style.animationDuration = (6 + Math.random() * 5) + "s";
    
    document.body.appendChild(el);
    
    // 动画结束后清理元素
    setTimeout(() => {
      el.remove();
    }, 10000);
  }

  // 每隔300ms生成一个
  setInterval(createFallingEmoji, 300);
 -->

</script>
</body>
</html>


<footer style="
  position: fixed;   /* 固定在页面底部 */
  bottom: 0;         /* 底部对齐 */
  left: 0;           /* 左边界对齐 */
  width: 100%;       /* 占满整个宽度 */
  text-align: center;
  padding: 10px 0;
  font-size: 15px;
  color: #696969;
  line-height: 2;
  background: rgba(255, 239, 250, 0.8); /* 可选：半透明背景 */
  z-index: 1000;     /* 确保覆盖在动画上面 */
">
  ✨💎 权志龙 2025 生日应援 · 我和GD的特别印记 💎✨<br>
  ❤ 出品：权志龙_FAMHOME ❤<br>
  🛠️ 开发：霜季Gliz 🛠️
</footer>

