<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>专属纪念头像生成器</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--accent:#ff3b30}
  body{font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;background:var(--bg);margin:0;padding:24px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh}
  .wrap{width:980px;max-width:95%;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{margin:0 0 10px;font-size:20px}
  p.note{margin:6px 0;color:#666;font-size:14px}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
  input[type="text"]{padding:8px 10px;font-size:15px;border:1px solid #ddd;border-radius:6px;width:320px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #canvas{border:1px solid #e2e2e2;margin-top:14px;max-width:100%}
  .small{font-size:13px;color:#888}
  #previewBox{display:flex;gap:20px;align-items:flex-start;margin-top:12px}
  .left{flex:1;min-width:260px}
  .right{width:360px}
  @font-face{font-family:'MyFont';src: url('fonts/MyFont.ttf') format('truetype');font-weight:normal;font-style:normal;}
</style>
<!-- <style>
  :root{--bg:#f7f7f7;--card:#fff;--accent:#ff3b30}

  @font-face {
      font-family: 'NotoSansSC';
      src: url('fonts/YeZiGongChangShanHaiChaoFengSong-2.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
  }

  @font-face {
      font-family: 'Roboto';
      src: url('fonts/Belianty-Elesha-2.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
  }

  body{
      font-family: 'NotoSansSC', 'Roboto', Arial, "Helvetica Neue", Helvetica, sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      min-height:100vh
  }

  .wrap{width:980px;max-width:95%;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{margin:0 0 10px;font-size:20px}
  p.note{margin:6px 0;color:#666;font-size:14px}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
  input[type="text"]{padding:8px 10px;font-size:15px;border:1px solid #ddd;border-radius:6px;width:320px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #canvas{border:1px solid #e2e2e2;margin-top:14px;max-width:100%}
  .small{font-size:13px;color:#888}
  #previewBox{display:flex;gap:20px;align-items:flex-start;margin-top:12px}
  .left{flex:1;min-width:260px}
  .right{width:360px}
</style> -->
</head>
<body>
  <div class="wrap">
    <h1>专属纪念头像生成器（纯前端）</h1>
    <p class="note">步骤：1) 输入订单号 → 验证成功后输入昵称 → 实时预览 → 下载PNG。若打开文件时发现“未找到订单”或画布空白，请用本地服务器运行（下面有说明）。</p>

    <div id="step1">
      <p><strong>1. 输入订单号以校验：</strong></p>
      <div class="row">
        <input id="orderId" type="text" placeholder="例如：A20250001" />
        <button id="checkBtn">校验订单</button>
      </div>
      <p class="small">提示：订单号来自你购买记录（就是 `data/orders.json` 中的键）。</p>
    </div>

    <div id="step2" style="display:none;margin-top:10px;">
      <p><strong>2. 输入昵称（会显示在头像上）：</strong></p>
      <div class="row">
        <input id="nickname" type="text" placeholder="昵称（只允许中英文和数字，最长12字符）" maxlength="12" />
        <button id="genBtn">生成并显示预览</button>
        <button id="downloadBtn" style="display:none;background:#333">下载PNG</button>
      </div>
      <p class="small">如果想在输入过程中实时看到效果，请直接在输入框输入，预览会自动更新。</p>
    </div>

    <div id="previewBox">
      <div class="left">
        <canvas id="canvas" width="1080" height="1080" style="display:none"></canvas>
      </div>
      <div class="right">
        <div id="info" style="font-size:14px;color:#444">
          <p>当前序号：<span id="currentNumber">—</span></p>
          <p>文件名示例：<span id="filenameExample">—</span></p>
          <p class="small">调整：要改变序号/昵称在图上的位置或样式，请编辑 <code>index.html</code> 内的 <code>numberPos</code>、<code>namePos</code> 和字体设置。</p>
        </div>
      </div>
    </div>

    <p style="margin-top:12px" class="small">常见问题：若页面在双击打开（file://）时无法加载数据，请使用命令行运行 `python -m http.server 8000`（或用 VSCode Live Server）。</p>
  </div>

<script>
(async ()=> {
  // ---------- 配置（方便你改位置/样式） ----------
  const canvasSize = { w:1080, h:1080 };
  const numberPos = { x: 200, y: 850, font: 'bold 60px MyFont', color: '#7DC8FF' };
  const namePos   = { x: 200, y: 950, font: 'bold 60px MyFont', color: '#FDABD6' };
  const allowedNameRegex = /^[\u4e00-\u9fa5A-Za-z0-9]+$/; // 允许中英与数字
  // -----------------------------------------------

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // 载入订单表（提前加载）
  let orders = null;
  async function loadOrders() {
    try {
      const resp = await fetch('data/orders.json', {cache: "no-store"});
      if (!resp.ok) throw new Error('fetch fail');
      orders = await resp.json();
      console.log('orders loaded, total keys:', Object.keys(orders).length);
    } catch (e) {
      alert('加载订单数据失败。注意：如果你直接双击打开 index.html (file://)，浏览器会阻止 fetch。本地测试请用本地服务器运行（见下方提示）。\n\n命令示例：在项目目录运行：\npython -m http.server 8000\n然后在浏览器打开 http://localhost:8000');
      console.error(e);
    }
  }
  await loadOrders();

  // 等待字体加载完再绘图（避免刚生成时字体未生效）
  async function waitFonts() {
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch(e){ /*ignore*/ }
    } else {
      // 旧浏览器：简短延时
      await new Promise(r=>setTimeout(r,300));
    }
  }

  // 绘制函数（底图 + 序号 + 名称）
  async function draw(number, name) {
    if (!orders) return;
    // 等待字体
    await waitFonts();
    // 加载底图
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = () => {
        canvas.width = canvasSize.w;
        canvas.height = canvasSize.h;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        // 序号
        ctx.fillStyle = numberPos.color;
        ctx.textAlign = 'left';
        ctx.font = numberPos.font;
        ctx.fillText(`No.${number}`, numberPos.x, numberPos.y);
        // 昵称
        ctx.fillStyle = namePos.color;
        ctx.font = namePos.font;
        ctx.fillText(name, namePos.x, namePos.y);
        canvas.style.display = 'block';
        resolve();
      };
      img.onerror = (e)=> reject(e);
      img.src = 'images/template.png';
      // 如果你模板很大，加载可能需要一点时间
    });
  }

  // 元素绑定
  const orderInput = document.getElementById('orderId');
  const checkBtn = document.getElementById('checkBtn');
  const step2 = document.getElementById('step2');
  const nicknameInput = document.getElementById('nickname');
  const genBtn = document.getElementById('genBtn');
  const downBtn = document.getElementById('downloadBtn');
  const currentNumberSpan = document.getElementById('currentNumber');
  const filenameExample = document.getElementById('filenameExample');

  let currentNumber = null;

  checkBtn.addEventListener('click', ()=>{
    const id = (orderInput.value||'').trim();
    if (!id) { alert('请输入订单号'); return; }
    if (!orders) { alert('订单数据未加载，请用本地服务器运行并刷新页面'); return; }
    if (!orders[id]) { alert('未找到该订单号，请检查 orders.json 是否已包含此订单号'); return; }
    currentNumber = orders[id];
    currentNumberSpan.textContent = currentNumber;
    filenameExample.textContent = `No_${currentNumber}_你的昵称.png`;
    step2.style.display = 'block';
    nicknameInput.focus();
    // 生成一次默认预览（昵称为空则显示占位）
    draw(currentNumber, nicknameInput.value || '昵称');
  });

  // 实时预览（输入时自动更新）
  nicknameInput.addEventListener('input', async ()=>{
    const name = nicknameInput.value.trim();
    if (!currentNumber) return;
    if (name && !allowedNameRegex.test(name)) {
      // 不允许的字符：不自动绘制（但不阻塞输入）
      // 也可以给视觉提示，这里用 console
      console.warn('昵称包含不允许字符');
    }
    // 绘制时如果为空，用占位
    await draw(currentNumber, name || '昵称');
  });

  genBtn.addEventListener('click', async ()=>{
    const name = nicknameInput.value.trim();
    if (!currentNumber) { alert('请先校验订单号'); return; }
    if (!name) { alert('请输入昵称'); return; }
    if (!allowedNameRegex.test(name)) { alert('昵称只能含中/英/数字'); return; }
    await draw(currentNumber, name);
    downBtn.style.display = 'inline-block';
    filenameExample.textContent = `No_${currentNumber}_${name}.png`;
  });

  downBtn.addEventListener('click', ()=>{
    const name = nicknameInput.value.trim() || '昵称';
    const link = document.createElement('a');
    const safeName = name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,'_');
    link.download = `No_${currentNumber}_${safeName}.png`;
    try {
      link.href = canvas.toDataURL('image/png');
      link.click();
    } catch (e) {
      alert('导出失败（可能是跨域问题），请确认 template.png 与本页面在同一域/同一服务器下运行。');
    }
  });

})();
</script>
</body>
</html>
