<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>DIY头像生成器</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--accent:#ff3b30}
  body{font-family: Arial,"Helvetica Neue",Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh}
  .wrap{width:980px;max-width:95%;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{margin:0 0 10px;font-size:20px}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
  input[type="text"], input[type="file"]{padding:8px 10px;font-size:15px;border:1px solid #ddd;border-radius:6px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #canvas{border:1px solid #e2e2e2;margin-top:14px;max-width:100%}
  @font-face{
    font-family:'MyFontCN';
    src: url('fonts/MyFontCN1.ttf') format('truetype');
  }
  @font-face{
    font-family:'MyFontEN';
    src: url('fonts/MyFontEN3.ttf') format('truetype');
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>DIY头像生成器</h1>
  
  <div class="row">
    <label>昵称：</label>
    <input type="text" id="nickname" placeholder="输入你的昵称">
  </div>
  
  <div class="row">
    <label>上传贴纸：</label>
    <input type="file" id="uploadSticker" accept="image/png, image/jpeg">
  </div>
  
  <div class="row">
    <button id="generate">生成头像</button>
    <button id="download">下载分享图</button>
  </div>
  
  <canvas id="canvas" width="500" height="500"></canvas>
</div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let stickerImg = null;
let templateImg = new Image();

// 贴纸位置与大小
let stickerX = 350, stickerY = 50, stickerW = 100, stickerH = 100;
let dragging = false, resizing = false;
let dragOffsetX = 0, dragOffsetY = 0;
const resizeHandleSize = 10;

// 加载底图
templateImg.src = 'images/template1.png';
templateImg.onload = drawCanvas;

// 上传贴纸
document.getElementById('uploadSticker').addEventListener('change', function(e){
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(evt){
    let img = new Image();
    img.onload = function(){
      stickerImg = img;
      drawCanvas();
    }
    img.src = evt.target.result;
  }
  reader.readAsDataURL(file);
});

// 生成头像（固定好贴纸位置）
document.getElementById('generate').addEventListener('click', drawCanvas);

// 下载分享图
document.getElementById('download').addEventListener('click', function(){
  let link = document.createElement('a');
  link.download = 'my-avatar.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

// 绘制画布
function drawCanvas(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // 底图
  ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
  
  // 昵称
  let nickname = document.getElementById('nickname').value;
  ctx.fillStyle = "#000";
  if (/[\u4e00-\u9fa5]/.test(nickname)) {
    ctx.font = "bold 36px MyFontCN";
  } else {
    ctx.font = "bold 36px MyFontEN";
  }
  ctx.textAlign = "center";
  ctx.fillText(nickname, 250, 480);
  
  // 贴纸
  if (stickerImg) {
    ctx.drawImage(stickerImg, stickerX, stickerY, stickerW, stickerH);
    // 画拖动边框和缩放点
    ctx.strokeStyle = "#666";
    ctx.strokeRect(stickerX, stickerY, stickerW, stickerH);
    ctx.fillStyle = "#ff3b30";
    ctx.fillRect(stickerX + stickerW - resizeHandleSize, stickerY + stickerH - resizeHandleSize, resizeHandleSize, resizeHandleSize);
  }
}

// 判断是否在贴纸上
function isOverSticker(x, y){
  return x >= stickerX && x <= stickerX + stickerW && y >= stickerY && y <= stickerY + stickerH;
}

// 判断是否在缩放点上
function isOverResizeHandle(x, y){
  return x >= stickerX + stickerW - resizeHandleSize && x <= stickerX + stickerW &&
         y >= stickerY + stickerH - resizeHandleSize && y <= stickerY + stickerH;
}

// 鼠标事件
canvas.addEventListener('mousedown', function(e){
  let rect = canvas.getBoundingClientRect();
  let mouseX = e.clientX - rect.left;
  let mouseY = e.clientY - rect.top;
  
  if (stickerImg && isOverResizeHandle(mouseX, mouseY)) {
    resizing = true;
  } else if (stickerImg && isOverSticker(mouseX, mouseY)) {
    dragging = true;
    dragOffsetX = mouseX - stickerX;
    dragOffsetY = mouseY - stickerY;
  }
});

canvas.addEventListener('mousemove', function(e){
  let rect = canvas.getBoundingClientRect();
  let mouseX = e.clientX - rect.left;
  let mouseY = e.clientY - rect.top;
  
  if (dragging) {
    stickerX = mouseX - dragOffsetX;
    stickerY = mouseY - dragOffsetY;
    drawCanvas();
  } else if (resizing) {
    stickerW = mouseX - stickerX;
    stickerH = mouseY - stickerY;
    drawCanvas();
  }
});

canvas.addEventListener('mouseup', function(){
  dragging = false;
  resizing = false;
});
</script>
</body>
</html>
